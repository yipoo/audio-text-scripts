# 音频文本处理平台 - 系统设计文档

## 1. 系统架构

### 1.1 整体架构

音频文本处理平台采用前后端分离的架构设计，主要由以下几个部分组成：

1. **前端应用层**：基于Next.js构建的Web应用，负责用户交互和数据展示
2. **后端API层**：基于FastAPI构建的RESTful API服务，负责处理前端请求和业务逻辑
3. **核心处理模块**：包含音频处理、文本处理和AI生成三个主要模块
4. **外部服务集成**：集成阿里云语音识别和DashScope AI服务

### 1.2 技术选型理由

| 技术 | 选择理由 |
|------|---------|
| Next.js | 提供服务端渲染能力，改善首屏加载性能；内置路由系统简化开发 |
| TypeScript | 提供类型安全，减少运行时错误，提高代码可维护性 |
| Ant Design | 成熟的企业级UI组件库，提供丰富的预设组件，加速开发 |
| FastAPI | 高性能的Python API框架，支持异步处理，自动生成API文档 |
| 阿里云NLS | 提供高准确度的中文语音识别服务，支持多种音频格式 |
| 阿里云DashScope | 提供强大的AI生成能力，支持多种内容创作场景 |

## 2. 数据流设计

### 2.1 主要数据流程

```
用户上传音频 → 音频存储 → 音频转写 → 文本分段 → 标签提取 → 脚本生成 → 结果存储 → 前端展示
```

### 2.2 数据存储

系统采用文件系统进行数据存储，主要包括：

1. **上传文件存储**：`/uploads` 目录，存储用户上传的原始音频文件
2. **任务结果存储**：`/output/{job_id}/` 目录，按任务ID组织，存储以下文件：
   - `status.json`：任务状态信息
   - `transcript.txt`：转写结果
   - `tags.json`：提取的标签
   - `scripts.json`：生成的脚本

### 2.3 状态管理

任务状态转换流程：

```
pending → processing → completed/error
```

- **pending**：任务已创建但尚未开始处理
- **processing**：任务正在处理中
- **completed**：任务已成功完成
- **error**：任务处理过程中出错

### 2.4 后台任务处理系统

为了提高系统响应性能，特别是在处理耗时较长的AI生成任务时，系统实现了一个后台任务处理机制：

1. **线程池执行器**：使用Python的`ThreadPoolExecutor`创建一个固定大小的线程池，用于执行后台任务
2. **任务跟踪系统**：记录所有后台任务的状态、开始时间、结束时间和执行结果
3. **异步执行模式**：将耗时操作（如脚本生成）放入后台线程执行，避免阻塞API响应
4. **状态监控API**：提供API端点查询系统资源状态和后台任务执行情况

后台任务状态转换流程：

```
pending → running → completed/error
```

任务跟踪信息包括：
- 任务ID和名称
- 执行状态（等待中、运行中、已完成、错误）
- 开始和结束时间
- 执行参数
- 执行结果或错误信息

## 3. 核心模块设计

### 3.1 音频处理模块 (audio_processing)

**主要职责**：
- 音频文件格式验证和预处理
- 调用阿里云NLS服务进行语音识别
- 处理识别结果并保存转写文本

**关键类**：
- `SpeechToText`：封装阿里云语音识别API的调用和结果处理

### 3.2 文本处理模块 (text_processing)

**主要职责**：
- 文本分段和清洗
- 关键词和主题标签提取
- 文本结构化分析

**关键类**：
- `TextSegmenter`：负责将长文本分割成有意义的段落
- `TextTagger`：负责从文本中提取关键词和主题标签

### 3.3 AI生成模块 (ai_generation)

**主要职责**：
- 基于转写文本和标签生成多种脚本变体
- 调用阿里云DashScope服务进行内容创作
- 处理和格式化生成结果

**关键类**：
- `ContentCreator`：封装阿里云DashScope API的调用和结果处理

## 4. API设计

### 4.1 RESTful API设计原则

- 使用HTTP标准方法（GET, POST, PUT, DELETE）
- 资源使用名词复数形式（如 `/jobs`）
- 使用嵌套资源表示从属关系（如 `/jobs/{job_id}/transcript`）
- 使用HTTP状态码表示请求结果
- 返回JSON格式的响应数据

### 4.2 主要API端点详细说明

#### 上传音频文件
```
POST /api/upload
Content-Type: multipart/form-data

Request:
- file: 音频文件 (WAV, MP3, M4A)

Response:
{
  "job_id": "uuid",
  "status": "processing",
  "message": "文件已上传，开始处理",
  "filename": "example.mp3"
}
```

#### 获取任务列表
```
GET /api/jobs

Response:
[
  {
    "job_id": "uuid1",
    "status": "completed",
    "filename": "example1.mp3",
    "created_at": "2025-03-21T10:00:00",
    "updated_at": "2025-03-21T10:05:00",
    "message": "处理完成"
  },
  {
    "job_id": "uuid2",
    "status": "processing",
    "filename": "example2.mp3",
    "created_at": "2025-03-21T10:10:00",
    "updated_at": "2025-03-21T10:10:00",
    "message": "正在转写音频"
  }
]
```

#### 获取转写结果
```
GET /api/jobs/{job_id}/transcript

Response:
"这是转写的文本内容..."
```

#### 获取标签
```
GET /api/jobs/{job_id}/tags

Response:
["标签1", "标签2", "标签3", ...]
```

#### 获取脚本
```
GET /api/jobs/{job_id}/scripts

Response:
{
  "original_text": "原始转写文本...",
  "scripts": [
    "脚本1内容...",
    "脚本2内容...",
    "脚本3内容..."
  ]
}
```

#### 生成脚本
```
POST /api/jobs/{job_id}/generate-scripts

Request:
{
  "num_scripts": 5
}

Response:
{
  "job_id": "uuid",
  "status": "processing",
  "message": "正在生成脚本"
}
```

#### 重试任务
```
POST /api/jobs/{job_id}/retry

Response:
{
  "job_id": "uuid",
  "status": "processing",
  "message": "正在重新处理"
}
```

## 5. 前端设计

### 5.1 页面结构

1. **首页**：
   - 服务状态概览
   - 文件上传区域
   - 快速导航

2. **任务管理页面**：
   - 任务列表表格
   - 任务状态过滤
   - 操作按钮（查看转写、查看标签、查看脚本、重试）

3. **模态框**：
   - 转写结果模态框
   - 标签模态框（查看/生成）
   - 脚本模态框（查看/生成）

### 5.2 组件设计

1. **AppLayout**：应用整体布局，包含导航栏和页面容器
2. **FileUploader**：文件上传组件，支持拖拽和点击上传
3. **JobsTable**：任务列表表格组件，支持状态过滤和操作
4. **StatusCard**：状态卡片组件，显示统计信息
5. **TranscriptModal**：转写结果模态框组件
6. **TagsModal**：标签模态框组件，支持查看和生成
7. **ScriptsModal**：脚本模态框组件，支持查看和生成

### 5.3 状态管理

使用React Hooks进行状态管理：

1. **全局状态**：
   - 使用Context API管理全局消息通知

2. **页面状态**：
   - 使用useState管理页面级别的状态
   - 使用useEffect处理副作用（如数据获取）

## 6. 异步任务处理

### 6.1 后台任务设计

系统使用FastAPI的BackgroundTasks处理长时间运行的任务：

1. **任务创建**：
   ```python
   background_tasks.add_task(process_audio_file, job_id, file_path)
   ```

2. **任务状态更新**：
   任务在执行过程中会更新status.json文件，前端通过轮询获取最新状态

### 6.2 错误处理与重试机制

1. **错误捕获**：
   - 使用try-except捕获处理过程中的异常
   - 记录详细错误日志
   - 更新任务状态为error并保存错误信息

2. **重试机制**：
   - 支持手动重试失败的任务
   - 根据任务当前状态决定从哪一步开始重试
   - 对于已有转写结果的任务，只重新生成标签和脚本

## 7. 安全考虑

### 7.1 API密钥管理

- 使用环境变量存储敏感信息（如API密钥）
- 不在代码中硬编码敏感信息
- 使用.env文件管理开发环境的环境变量

### 7.2 文件安全

- 使用唯一的任务ID作为文件夹名称，避免文件覆盖
- 验证上传文件的类型和大小
- 限制上传文件的格式（仅允许WAV、MP3、M4A）

### 7.3 错误信息处理

- 对外部展示友好的错误信息
- 详细的内部错误日志，便于调试
- 避免在错误响应中泄露敏感信息

## 8. 性能优化

### 8.1 前端优化

1. **懒加载**：
   - 组件懒加载
   - 图片懒加载

2. **状态管理**：
   - 避免不必要的状态更新
   - 使用useMemo和useCallback优化渲染性能

3. **UI响应**：
   - 添加加载状态指示器
   - 使用骨架屏提升感知性能

### 8.2 后端优化

1. **异步处理**：
   - 使用异步处理长时间运行的任务
   - 避免阻塞主线程

2. **缓存策略**：
   - 缓存频繁访问的资源
   - 避免重复计算

3. **文件处理**：
   - 分块处理大文件
   - 使用流式处理减少内存占用

## 9. 可扩展性设计

### 9.1 模块化设计

- 核心功能模块化，便于替换和升级
- 清晰的接口定义，降低模块间耦合

### 9.2 扩展点

1. **音频处理**：
   - 支持添加新的语音识别服务提供商
   - 支持更多音频格式

2. **文本处理**：
   - 支持添加新的文本分析算法
   - 支持多语言处理

3. **AI生成**：
   - 支持添加新的AI模型
   - 支持更多内容生成场景

## 10. 测试策略

### 10.1 单元测试

- 使用pytest测试核心功能模块
- 模拟外部依赖，确保测试的独立性

### 10.2 集成测试

- 测试模块间的交互
- 测试与外部服务的集成

### 10.3 端到端测试

- 使用Playwright进行端到端测试
- 模拟用户操作，验证完整流程

## 11. 部署与运维

### 11.1 部署方案

1. **开发环境**：
   - 本地开发服务器
   - 使用dotenv加载环境变量

2. **生产环境**：
   - 可部署到任何支持Node.js和Python的服务器
   - 使用环境变量配置

### 11.2 监控与日志

- 使用Python logging模块记录详细日志
- 按模块和级别组织日志
- 记录关键操作和错误信息

### 11.3 备份策略

- 定期备份任务数据
- 备份环境配置
- 制定数据恢复计划

## 12. 未来规划

### 12.1 近期计划

1. **用户认证系统**：
   - 实现用户注册和登录
   - 任务隔离和权限控制

2. **数据库集成**：
   - 使用关系型数据库替代文件存储
   - 提升数据查询和管理效率

3. **API文档完善**：
   - 完善Swagger文档
   - 提供API使用示例

### 12.2 中期计划

1. **多语言支持**：
   - 支持英文等多语言音频转写
   - 多语言界面

2. **高级分析功能**：
   - 情感分析
   - 内容分类
   - 关键信息提取

3. **批量处理优化**：
   - 并行处理多个任务
   - 任务优先级队列

### 12.3 长期愿景

1. **AI能力增强**：
   - 自定义AI模型训练
   - 领域特定优化

2. **生态系统构建**：
   - 开放API接口
   - 插件系统
   - 第三方集成

3. **移动端支持**：
   - 响应式设计优化
   - 移动应用开发

---

文档版本：1.0.0
最后更新：2025-03-21
作者：音频文本处理平台开发团队
